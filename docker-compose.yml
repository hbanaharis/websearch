version: '3'

# Minimal docker-compose showing websearch retriever + dependencies.
# Adapt to your own infrastructure as needed.

services:
  # SearXNG meta-search engine (no API keys, aggregates Google/Bing/DDG/PubMed)
  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    ports:
      - "8088:8080"
    environment:
      - BASE_URL=http://localhost:8088/
      - INSTANCE_NAME=websearch
    volumes:
      - ./searxng:/etc/searxng:rw
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: always

  # Web search retriever (FastAPI â€” search + page content extraction)
  websearch:
    build:
      context: .
    container_name: websearch_retriever
    ports:
      - "8089:8080"
    volumes:
      - ./main.py:/app/main.py
      - ./data:/data
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - SEARXNG_URL=http://searxng:8080
      - EMBED_PROXY_URL=http://embed_proxy:8085    # Optional: for semantic re-ranking + chunking
      - EMBED_PROXY_USER=admin
      - EMBED_PROXY_PASS=${EMBED_PROXY_PASS}
      - API_KEYS=${WEBSEARCH_API_KEY}               # Comma-separated Bearer tokens; empty = no auth
      - FETCH_TIMEOUT=20
      - IMAGE_MAX_BYTES=8000000
      - USER_AGENT=Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122 Safari/537.36
      - PYTHONUNBUFFERED=1
    depends_on:
      - searxng
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: always
